<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bingo ‚Äì PictoSuite</title>
    <link href="https://fonts.googleapis.com/css2?family=Andika&family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-fons: #fdfbf7;
            --color-principal: #e67e22;
            --color-secundari: #f39c12;
            --color-accio: #27ae60;
            --color-text: #333333;
            --font-titols: 'Fredoka', sans-serif;
            --font-text: 'Andika', sans-serif;
        }

        body {
            font-family: var(--font-text);
            background-color: var(--color-fons);
            background-image: linear-gradient(#e1e1e1 1px, transparent 1px), linear-gradient(90deg, #e1e1e1 1px, transparent 1px);
            background-size: 20px 20px;
            color: var(--color-text);
            margin: 0;
            padding: 20px;
        }

        body.dark-mode {
            --color-fons: #1e1e2e;
            --color-text: #cdd6f4;
            background-color: #1e1e2e;
            background-image: linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px);
        }
        body.dark-mode .configuracio { background-color: #2a2a3e; color: #cdd6f4; }
        body.dark-mode label { color: #a6adc8; }
        body.dark-mode .sidebar-label { color: #a6adc8; }
        body.dark-mode .sidebar-input { background: #1e1e2e; color: #cdd6f4; border-color: #555; }
        body.dark-mode .side-menu { background-color: #2a2a3e; }
        body.dark-mode .side-menu a { color: #cdd6f4; }
        body.dark-mode .side-menu a:hover { background-color: #1e1e2e; }
        body.dark-mode .side-menu select.sidebar-input { background: #1e1e2e; color: #cdd6f4; border-color: #555; }
        body.dark-mode input[type="text"], body.dark-mode select, body.dark-mode textarea { background: #1e1e2e; color: #cdd6f4; border-color: #555; }
        body.dark-mode .header-app h1 { color: #ffffff; }
        body.dark-mode .bingo-card { background: #2a2a3e; border-color: #555; }
        body.dark-mode .bingo-cell { background: #1e1e2e; border-color: #555; color: #cdd6f4; }
        body.dark-mode .avis { background: #3a3a4e; border-color: #666; color: #cdd6f4; }

        .menu-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background-color: #27ae60;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 24px;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: background 0.3s;
        }

        .side-menu {
            height: 100%;
            width: 0;
            position: fixed;
            z-index: 1001;
            top: 0;
            left: 0;
            background-color: #ffffff;
            overflow-x: hidden;
            overflow-y: auto;
            transition: 0.4s;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            padding-top: 70px;
            display: flex;
            flex-direction: column;
            font-family: var(--font-titols);
        }
        .side-menu a { padding: 15px 25px; text-decoration: none; font-size: 18px; color: var(--color-text); display: block; transition: 0.2s; }
        .side-menu a:hover { background-color: #f0f8ff; color: var(--color-principal); }
        .side-menu .close-btn { position: absolute; top: 10px; right: 20px; font-size: 30px; background: none; border: none; cursor: pointer; color: #999; }
        .sidebar-section { padding: 10px 25px; }
        .sidebar-label { display: block; font-size: 0.82em; font-weight: bold; color: #555; margin-bottom: 4px; font-family: var(--font-titols); }
        .sidebar-input { width: 100%; box-sizing: border-box; padding: 7px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.85em; }
        .sidebar-btn { margin-top: 5px; background: var(--color-accio); color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 0.85em; width: 100%; font-weight: bold; }
        .toggle-wrap { display: flex; justify-content: space-between; align-items: center; padding: 10px 25px; }
        .toggle-switch { position: relative; display: inline-block; width: 46px; height: 22px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; border-radius: 22px; transition: .3s; }
        .toggle-slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: .3s; }
        input:checked + .toggle-slider { background-color: var(--color-principal); }
        input:checked + .toggle-slider:before { transform: translateX(24px); }

        .configuracio {
            background-color: #fff;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,.1);
            max-width: 950px;
            margin: 0 auto 20px;
            border-left: 10px solid var(--color-principal);
        }
        .header-app { display: flex; align-items: center; justify-content: center; gap: 15px; margin-top: 25px; margin-bottom: 20px; text-align: center; }
        .header-app h1 { margin: 0; color: #333333; font-family: var(--font-titols); font-size: 2.5rem; letter-spacing: 1px; }

        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; font-size: .9em; }
        input[type="text"], select, textarea { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        textarea { resize: vertical; min-height: 100px; font-family: var(--font-text); }

        .fila-flex { display: flex; gap: 15px; margin-bottom: 15px; align-items: flex-end; flex-wrap: wrap; }
        .columna { flex: 1; min-width: 120px; }

        .btn-container { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        button { border: none; padding: 12px 25px; font-size: 16px; border-radius: 50px; cursor: pointer; font-weight: bold; color: #fff; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: transform .1s; font-family: var(--font-titols); }
        button:active { transform: scale(.98); }
        .btn-generar { background-color: var(--color-principal); flex: 2; }
        .btn-imprimir { background-color: var(--color-accio); flex: 1; }
        .btn-ia { background-color: #8e44ad; flex: 1; }

        .avis { margin-top: 15px; padding: 10px 15px; background-color: #fef3cd; border-left: 4px solid #f39c12; border-radius: 4px; color: #7d5a00; font-size: .9em; display: none; }
        .avis.error { background-color: #fce4e4; border-left-color: #e74c3c; color: #a00; }
        .avis.ok { background-color: #e8f8f5; border-left-color: #27ae60; color: #166534; }

        /* Bingo cards output */
        #zona-sortida { max-width: 1200px; margin: 0 auto; }
        .bingo-card {
            background: white;
            border: 3px solid #333;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 20px;
            break-inside: avoid;
            page-break-inside: avoid;
            display: inline-block;
            width: 100%;
            box-sizing: border-box;
        }
        .bingo-card-title {
            font-family: var(--font-titols);
            font-size: 1.2em;
            text-align: center;
            margin-bottom: 8px;
            color: var(--color-principal);
        }
        .bingo-grid {
            display: grid;
            gap: 4px;
        }
        .bingo-cell {
            border: 2px solid #333;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4px;
            background: white;
            aspect-ratio: 1;
            overflow: hidden;
            text-align: center;
            font-size: 0.85em;
            font-weight: bold;
            word-break: break-word;
        }
        .bingo-cell img { width: 80%; height: 70%; object-fit: contain; display: block; }
        .bingo-cell .cell-text { font-size: 0.8em; margin-top: 2px; font-weight: bold; }
        .bingo-cell.nomes-text { font-size: 1.1em; }
        .bingo-cell.nomes-text img { display: none; }
        .bingo-cell.nomes-img .cell-text { display: none; }
        .bingo-cell.nomes-img img { width: 90%; height: 90%; }

        .cards-container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: flex-start; }
        .bingo-card { width: calc(50% - 10px); }

        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--color-principal); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media print {
            @page { margin: 10mm; size: A4 portrait; }
            body { background: #fff; padding: 0; margin: 0; background-image: none; }
            .configuracio, .menu-btn, .side-menu, #modal-contacte, #modal-ia, .no-print { display: none !important; }
            #zona-sortida { max-width: 100%; }
            .bingo-card { break-inside: avoid; page-break-inside: avoid; }
            .cards-container { display: block; }
            .bingo-card { width: 100%; margin-bottom: 15mm; }
        }

        /* Modal editor (same as Targetes) */
        #modal-edicio{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:3000;justify-content:center;align-items:center}
        .modal-contingut{background:#fff;border-radius:12px;width:90%;max-width:650px;display:flex;flex-direction:column;max-height:90vh;overflow:hidden}
        .modal-tabs{display:flex;background:#f1f1f1;border-bottom:2px solid #ddd;overflow-x:auto;flex-shrink:0}
        .tab-btn{flex:1;padding:10px 4px;border:none;background:none;cursor:pointer;font-weight:600;color:#666;border-bottom:3px solid transparent;display:flex;align-items:center;justify-content:center;white-space:nowrap;gap:5px;min-width:auto}
        .tab-btn.actiu{border-bottom:3px solid var(--color-principal);color:var(--color-principal);background:#fff;font-weight:bold}
        .modal-body{padding:25px;overflow-y:auto}
        .grup-titol-modal{margin-bottom:20px;text-align:center}
        .inputs-container-modal{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:15px;justify-content:center}
        .input-text-modal{font-size:1.1em;text-align:center;border:2px solid #ddd;padding:8px;border-radius:6px;box-sizing:border-box}
        .dues-paraules .input-text-modal{width:48%}
        .color-palette{display:flex;flex-direction:row;flex-wrap:wrap;justify-content:center;gap:10px}
        .color-btn{width:30px;height:30px;border-radius:50%;border:2px solid #ccc;cursor:pointer;transition:.2s;box-sizing:border-box;padding:0}
        .color-btn:hover{transform:scale(1.1);border-color:#333}
        .cerca-wrapper{display:flex;gap:8px;margin-bottom:15px}
        .btn-cerca-modal{background:var(--color-principal);border-radius:8px;padding:10px 20px;font-size:1em;flex-shrink:0;color:#fff;border:none;cursor:pointer}
        .btn-cerca-trad{background:#8e44ad}
        .resultats-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:10px;margin-top:15px}
        .resultats-grid img{width:100%;height:90px;object-fit:contain;border:1px solid #eee;border-radius:8px;cursor:pointer;padding:5px}
        .resultats-grid img:hover{transform:scale(1.05);border-color:var(--color-principal);background:#f0f8ff}
        .grid-traduccions{display:flex;flex-direction:column;gap:10px;margin-top:15px}
        .item-traduccio{display:flex;justify-content:space-between;align-items:center;background:#f8f9fa;padding:10px;border-radius:8px;border:1px solid #eee;cursor:pointer;transition:.2s}
        .item-traduccio:hover{background:#e8f6f3;border-color:#27ae60}
        .lang-code{font-weight:bold;color:#555;background:#ddd;padding:2px 6px;border-radius:4px;font-size:.8em;margin-right:10px}
        .copy-hint{font-size:.8em;color:#27ae60;opacity:0;transition:.2s}
        .item-traduccio:hover .copy-hint{opacity:1}
        .toolbar-dibuix{display:flex;gap:8px;margin-bottom:5px;align-items:center;flex-wrap:wrap;justify-content:center}
        .btn-color-dibuix{width:30px;height:30px;border-radius:50%;border:2px solid #fff;box-shadow:0 2px 4px rgba(0,0,0,.3);cursor:pointer;flex-shrink:0;box-sizing:border-box;padding:0}
        .btn-tool{background:#fff;border:1px solid #ccc;font-size:1.2em;border-radius:5px;padding:5px 10px;cursor:pointer;transition:.2s;flex-shrink:0}
        .btn-tool.actiu{background:#e8f8f5;border:2px solid var(--color-accio);box-shadow:0 0 5px rgba(39,174,96,.3)}
        .caixa-idiomes-check{max-height:150px;overflow-y:auto;border:2px solid #eee;padding:10px;border-radius:8px;margin-bottom:10px;display:grid;grid-template-columns:1fr 1fr;gap:5px;text-align:left;background:#fafafa}
        .caixa-idiomes-check label{margin:0;font-weight:normal;font-size:.9em;display:flex;align-items:center;gap:5px;cursor:pointer}
        @media screen and (max-width:850px){.modal-contingut{width:95%;height:90vh;max-height:90vh}}
    </style>
</head>
<body>

    <div class="configuracio">
        <div class="header-app">
            <span style="font-size:4rem;" aria-label="Bingo">üéØ</span>
            <h1>Bingo</h1>
        </div>

        <div class="fila-flex">
            <div class="columna" style="display:flex;flex-direction:column;gap:5px;">
                <label data-i18n="mida_cartro">Mida del cartr√≥</label>
                <div style="display:flex;gap:8px;align-items:center;">
                    <div style="flex:1;">
                        <label for="bingo-files" style="font-size:0.8em;margin-bottom:2px;" data-i18n="files_bingo">Files</label>
                        <input type="number" id="bingo-files" value="5" min="2" max="10" style="width:100%;padding:8px;border:2px solid #ddd;border-radius:8px;font-size:16px;box-sizing:border-box;">
                    </div>
                    <span style="font-size:1.5em;font-weight:bold;margin-bottom:0;align-self:flex-end;padding-bottom:8px;">√ó</span>
                    <div style="flex:1;">
                        <label for="bingo-columnes" style="font-size:0.8em;margin-bottom:2px;" data-i18n="columnes_bingo">Columnes</label>
                        <input type="number" id="bingo-columnes" value="5" min="2" max="10" style="width:100%;padding:8px;border:2px solid #ddd;border-radius:8px;font-size:16px;box-sizing:border-box;">
                    </div>
                </div>
            </div>
            <div class="columna">
                <label data-i18n="num_jugadors">Nombre de cartrons</label>
                <select id="num-jugadors">
                    <option value="1">1 cartr√≥</option>
                    <option value="2">2 cartrons</option>
                    <option value="3">3 cartrons</option>
                    <option value="4" selected>4 cartrons</option>
                    <option value="5">5 cartrons</option>
                    <option value="6">6 cartrons</option>
                    <option value="8">8 cartrons</option>
                    <option value="10">10 cartrons</option>
                    <option value="15">15 cartrons</option>
                    <option value="20">20 cartrons</option>
                    <option value="30">30 cartrons</option>
                </select>
            </div>
            <div class="columna">
                <label data-i18n="mode_visual">Mode de visualitzaci√≥</label>
                <select id="mode-visual">
                    <option value="imatge+text" selected data-i18n-opt="opt_imatgetext">Imatge + Text</option>
                    <option value="nomes-img" data-i18n-opt="opt_nomesimg">Nom√©s pictogrames</option>
                    <option value="nomes-text" data-i18n-opt="opt_nomestext">Nom√©s text</option>
                </select>
            </div>
            <div class="columna">
                <label data-i18n="mida_paper_bingo">Mida impressi√≥</label>
                <select id="mida-paper">
                    <option value="a4" selected>A4</option>
                    <option value="a3">A3</option>
                </select>
            </div>
            <div class="columna">
                <label data-i18n="orientacio_paper">Orientaci√≥</label>
                <select id="orientacio-paper">
                    <option value="portrait" selected data-i18n-opt="opt_vertical">Vertical</option>
                    <option value="landscape" data-i18n-opt="opt_horitzontal">Horitzontal</option>
                </select>
            </div>
        </div>

        <div style="margin-bottom:15px;">
            <label data-i18n="paraules_bingo">Paraules (separades amb comes):</label>
            <textarea id="llista-paraules" placeholder="Ex: gat, gos, ocell, peix, conill, cavall, vaca, ovella, porc..."></textarea>
        </div>

        <div id="avis-paraules" class="avis"></div>

        <div class="btn-container">
            <button class="btn-generar" onclick="generarBingo()" data-i18n="generar_bingo">üéØ Generar Bingo</button>
            <button class="btn-ia" onclick="obrirModalIA()" data-i18n="mode_ia">ü§ñ Mode IA</button>
            <button class="btn-imprimir" onclick="imprimirBingo()" data-i18n="imprimir">üñ®Ô∏è Imprimir</button>
        </div>
    </div>

    <!-- Modal IA -->
    <div id="modal-ia" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:2000;justify-content:center;align-items:center;">
        <div style="background:#fff;border-radius:12px;width:90%;max-width:500px;padding:30px;box-shadow:0 10px 30px rgba(0,0,0,0.3);">
            <h3 style="margin-top:0;color:#8e44ad;font-family:var(--font-titols);">ü§ñ Mode IA ‚Äì Genera paraules autom√†ticament</h3>
            <p style="color:#666;font-size:0.9em;" data-i18n="ia_descripcio">Escriu una tem√†tica i la IA generar√† una llista de paraules per al Bingo.</p>
            <label style="color:#333;font-weight:bold;" data-i18n="tematica">Tem√†tica:</label>
            <input type="text" id="ia-tematica" placeholder="Ex: animals de granja, fruites, professions..." style="margin-bottom:15px;">
            <label style="color:#333;font-weight:bold;" data-i18n="num_paraules_ia">Nombre de paraules:</label>
            <input type="text" id="ia-num-paraules" value="30" style="margin-bottom:15px;">
            <div style="display:flex;gap:10px;justify-content:center;">
                <button onclick="generarParaulesIA()" style="background:#8e44ad;color:white;padding:10px 20px;border-radius:30px;border:none;cursor:pointer;font-weight:bold;" data-i18n="generar_ia">‚ú® Genera paraules</button>
                <button onclick="document.getElementById('modal-ia').style.display='none'" style="background:#999;color:white;padding:10px 20px;border-radius:30px;border:none;cursor:pointer;font-weight:bold;" data-i18n="tancar">Tancar</button>
            </div>
            <div id="ia-estat" style="margin-top:15px;text-align:center;color:#8e44ad;font-size:0.9em;"></div>
        </div>
    </div>

    <!-- Modal editor de casella (igual que Targetes: pestanyes Pictos, Traductor, Pujar, IA, Editar) -->
    <div id="modal-edicio">
        <div class="modal-contingut">
            <div class="modal-tabs">
                <button class="tab-btn actiu" onclick="canviarPestanya('tab-arasaac')">üß© Pictos</button>
                <button id="tab-btn-traductor" class="tab-btn" onclick="canviarPestanya('tab-traductor')">üåç Traductor</button>
                <button id="tab-btn-pujar" class="tab-btn" onclick="canviarPestanya('tab-pujar')">üì§ Pujar</button>
                <button id="tab-btn-ia" class="tab-btn" onclick="canviarPestanya('tab-ia-img')">ü§ñ IA</button>
                <button class="tab-btn" onclick="obrirTabEdicio()">üé® Editar</button>
            </div>
            <div class="modal-body">
                <div class="grup-titol-modal">
                    <label style="margin-bottom:10px;">Editar Text:</label>
                    <div id="camps-text" class="inputs-container-modal"></div>
                </div>
                <div id="tab-arasaac" class="contingut-tab">
                    <div class="cerca-wrapper"><input id="input-arasaac" onkeyup="if(event.key==='Enter') buscarArasaacModal()"><button class="btn-cerca-modal" onclick="buscarArasaacModal()">üîç Cerca</button></div>
                    <div id="resultats-arasaac" class="resultats-grid"></div>
                </div>
                <div id="tab-traductor" class="contingut-tab" style="display:none;">
                    <p style="font-size:0.9em; margin-top:0;">Tria els idiomes a traduir per al text:</p>
                    <div class="caixa-idiomes-check">
                        <label><input type="checkbox" value="es" class="check-trad" checked> Castell√†</label>
                        <label><input type="checkbox" value="en" class="check-trad" checked> Angl√®s</label>
                        <label><input type="checkbox" value="fr" class="check-trad"> Franc√®s</label>
                        <label><input type="checkbox" value="de" class="check-trad"> Alemany</label>
                        <label><input type="checkbox" value="it" class="check-trad"> Itali√†</label>
                        <label><input type="checkbox" value="pt" class="check-trad"> Portugu√®s</label>
                        <label><input type="checkbox" value="nl" class="check-trad"> Neerland√®s</label>
                        <label><input type="checkbox" value="ro" class="check-trad"> Roman√®s</label>
                        <label><input type="checkbox" value="pl" class="check-trad"> Polon√®s</label>
                        <label><input type="checkbox" value="uk" class="check-trad"> Ucra√Øn√®s</label>
                        <label><input type="checkbox" value="ru" class="check-trad"> Rus</label>
                        <label><input type="checkbox" value="ar" class="check-trad"> √Ärab</label>
                        <label><input type="checkbox" value="zh" class="check-trad"> Xin√®s</label>
                        <label><input type="checkbox" value="ur" class="check-trad"> Urdu</label>
                    </div>
                    <div class="cerca-wrapper"><button class="btn-cerca-modal btn-cerca-trad" onclick="traduirParaula()" style="width:100%">üåç Traduir text</button></div>
                    <div id="resultats-traductor" class="grid-traduccions"></div>
                </div>
                <div id="tab-pujar" class="contingut-tab" style="display:none;text-align:center;">
                    <p>Puja una imatge pr√≤pia des del teu ordinador:</p>
                    <input type="file" accept="image/*" onchange="pujarImatge(this)" style="margin-top:10px;">
                </div>
                <div id="tab-ia-img" class="contingut-tab" style="display:none;text-align:center;">
                    <p style="font-size:1.1em; margin-bottom:15px; color:#555;">Genera imatges amb Intel¬∑lig√®ncia Artificial fent servir l'eina externa gratu√Øta de Craiyon.</p>
                    <button onclick="window.open('https://www.craiyon.com/','_blank','width=400,height=600')" style="background:var(--color-accio);color:white;padding:15px 25px;border-radius:30px;font-size:1.1em;border:none;cursor:pointer;font-weight:bold;box-shadow:0 4px 10px rgba(0,0,0,0.2);display:block;margin:0 auto;">üé® Obrir generador Craiyon</button>
                    <p style="font-size:0.85em; margin-top:20px; color:#999;">Guarda la imatge al teu ordinador i puja-la a la pestanya "Pujar".</p>
                </div>
                <div id="tab-dibuix" class="contingut-tab" style="display:none; text-align:center;">
                    <div style="display:flex; gap:10px; margin-bottom:15px; align-items:stretch;">
                        <div style="flex:1; background:#fffcf5; padding:10px; border-radius:10px; border:1px dashed #ccc; display:flex; flex-direction:column; justify-content:center;">
                            <label style="margin-top:0; margin-bottom:5px; font-size:0.85em; font-weight:bold;">üé® Fons targeta:</label>
                            <div class="color-palette" style="margin-bottom:0; justify-content:space-around;">
                                <button class="color-btn" style="background:#ffffff; border-color:#333;" onclick="setTargetColor('#ffffff', this)"></button>
                                <button class="color-btn" style="background:#ffe082" onclick="setTargetColor('#ffe082', this)"></button>
                                <button class="color-btn" style="background:#a5d6a7" onclick="setTargetColor('#a5d6a7', this)"></button>
                                <button class="color-btn" style="background:#90caf9" onclick="setTargetColor('#90caf9', this)"></button>
                                <button class="color-btn" style="background:#ffcc80" onclick="setTargetColor('#ffcc80', this)"></button>
                                <button class="color-btn" style="background:#e1bee7" onclick="setTargetColor('#e1bee7', this)"></button>
                            </div>
                        </div>
                        <div style="flex:1; background:#f0f8ff; padding:10px; border-radius:10px; border:1px dashed #ccc; display:flex; flex-direction:column; justify-content:center;">
                            <label style="margin-top:0; margin-bottom:5px; font-size:0.85em; font-weight:bold;">üñåÔ∏è Color d'edici√≥:</label>
                            <div class="color-palette" style="margin-bottom:0; justify-content:space-around;">
                                <button class="btn-color-dibuix" style="background:#e74c3c" onclick="setDrawColor('#e74c3c')"></button>
                                <button class="btn-color-dibuix" style="background:#2980b9" onclick="setDrawColor('#2980b9')"></button>
                                <button class="btn-color-dibuix" style="background:#27ae60" onclick="setDrawColor('#27ae60')"></button>
                                <button class="btn-color-dibuix" style="background:#f1c40f" onclick="setDrawColor('#f1c40f')"></button>
                                <button class="btn-color-dibuix" style="background:#000000" onclick="setDrawColor('#000000')"></button>
                            </div>
                        </div>
                    </div>
                    <div style="display:flex; flex-direction:column; align-items:center; gap:10px;">
                        <div class="toolbar-dibuix">
                            <button id="tool-freehand" class="btn-tool actiu" onclick="setTool('freehand')" title="Dibuix Lliure">„Ä∞Ô∏è</button>
                            <button id="tool-rect" class="btn-tool" onclick="setTool('rect')" title="Quadrat">üî≤</button>
                            <button id="tool-circle" class="btn-tool" onclick="setTool('circle')" title="Cercle">‚≠ï</button>
                            <button id="tool-arrow" class="btn-tool" onclick="setTool('arrow')" title="Fletxa">‚ÜóÔ∏è</button>
                            <button id="tool-cross" class="btn-tool" onclick="setTool('cross')" title="Creu">‚ùå</button>
                            <div style="width:2px; height:20px; background:#ccc; margin:0 5px;"></div>
                            <button style="background:#95a5a6; border:none; padding:5px 15px; border-radius:5px; color:white; cursor:pointer; font-size:1.2em; font-weight:bold;" onclick="undoLastDrawing()" title="Desfer √∫ltim pas">‚Ü©Ô∏è</button>
                            <button style="background:#e74c3c; border:none; padding:5px 12px; border-radius:5px; color:white; cursor:pointer; font-size:1.2em; font-weight:bold;" onclick="eliminarElementSeleccionat()" title="Eliminar element seleccionat">üóëÔ∏è</button>
                        </div>
                        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:center; background:#eee; padding:10px; border-radius:10px; width:100%; box-sizing:border-box;">
                            <label style="font-size:0.8em; font-weight:bold;">üîç Mida: <input type="range" id="ed-scale" min="0.5" max="3" step="0.1" value="1" oninput="drawEditorCanvas()"></label>
                            <label style="font-size:0.8em; font-weight:bold;">‚ÜîÔ∏è X: <input type="range" id="ed-x" min="-150" max="150" value="0" oninput="drawEditorCanvas()"></label>
                            <label style="font-size:0.8em; font-weight:bold;">‚ÜïÔ∏è Y: <input type="range" id="ed-y" min="-150" max="150" value="0" oninput="drawEditorCanvas()"></label>
                        </div>
                        <div style="position:relative;display:inline-block;">
                            <canvas id="canvasEditor" width="300" height="300" style="border:2px dashed #ccc; border-radius:10px; touch-action:none; background:white; cursor:crosshair;"></canvas>
                            <input type="text" id="canvas-inline-text" placeholder="Escriu i prem ‚Üµ" style="display:none;position:absolute;background:rgba(255,255,255,0.95);border:2px solid #4a90e2;border-radius:4px;padding:3px 8px;font:bold 14px Arial;min-width:90px;z-index:5;box-shadow:0 2px 6px rgba(0,0,0,0.2);">
                        </div>
                    </div>
                </div>
            </div>
            <div style="padding:15px;background:#f9f9f9; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
                <button onclick="eliminarTargeta()" style="background:#e74c3c; color:white; display:inline-flex; border:none; padding:10px 15px; border-radius:8px; cursor:pointer; font-weight:bold;">üóëÔ∏è Buidar casella</button>
                <div style="display:flex; gap:10px;">
                    <button onclick="guardarTancar()" style="background:var(--color-accio);display:inline-flex; border:none; padding:10px 15px; border-radius:8px; cursor:pointer; font-weight:bold; color:white;">‚úÖ Fet</button>
                    <button onclick="tancarModalSenseGuardar()" style="background:#999;display:inline-flex; border:none; padding:10px 15px; border-radius:8px; cursor:pointer; font-weight:bold; color:white;">Cancel¬∑lar</button>
                </div>
            </div>
        </div>
    </div>
    <div id="toast" style="display:none; position:fixed; bottom:30px; left:50%; transform:translateX(-50%); background:#333; color:white; padding:10px 20px; border-radius:30px; z-index:4000;">Copiat!</div>

    <div id="zona-sortida"></div>

    <script src="menu.js"></script>
    <script>
        const i18nUI = {
            ca: { mode_fosc:"üåô Mode Fosc", idioma_ui:"üåê Idioma de l'aplicaci√≥", clau_api:"ü§ñ Clau API Google AI Studio:", desar_clau:"üíæ Desar clau", aconseguir_clau:"üëâ Aconseguir clau gratis", suggerencia:"‚úâÔ∏è Tens alguna sugger√®ncia?", mida_cartro:"Mida del cartr√≥", num_jugadors:"Nombre de cartrons", mode_visual:"Mode de visualitzaci√≥", mida_paper_bingo:"Mida impressi√≥", orientacio_paper:"Orientaci√≥", paraules_bingo:"Paraules (separades amb comes):", generar_bingo:"üéØ Generar Bingo", mode_ia:"ü§ñ Mode IA", imprimir:"üñ®Ô∏è Imprimir", ia_descripcio:"Escriu una tem√†tica i la IA generar√† una llista de paraules per al Bingo.", tematica:"Tem√†tica:", num_paraules_ia:"Nombre de paraules:", generar_ia:"‚ú® Genera paraules", tancar:"Tancar", opt_imatgetext:"Imatge + Text", opt_nomesimg:"Nom√©s pictogrames", opt_nomestext:"Nom√©s text", files_bingo:"Files", columnes_bingo:"Columnes" },
            es: { mode_fosc:"üåô Modo Oscuro", idioma_ui:"üåê Idioma de la aplicaci√≥n", clau_api:"ü§ñ Clave API Google AI Studio:", desar_clau:"üíæ Guardar clave", aconseguir_clau:"üëâ Obtener clave gratis", suggerencia:"‚úâÔ∏è ¬øAlguna sugerencia?", mida_cartro:"Tama√±o del cart√≥n", num_jugadors:"N√∫mero de cartones", mode_visual:"Modo de visualizaci√≥n", mida_paper_bingo:"Tama√±o impresi√≥n", orientacio_paper:"Orientaci√≥n", paraules_bingo:"Palabras (separadas por comas):", generar_bingo:"üéØ Generar Bingo", mode_ia:"ü§ñ Modo IA", imprimir:"üñ®Ô∏è Imprimir", ia_descripcio:"Escribe una tem√°tica y la IA generar√° una lista de palabras para el Bingo.", tematica:"Tem√°tica:", num_paraules_ia:"N√∫mero de palabras:", generar_ia:"‚ú® Generar palabras", tancar:"Cerrar", opt_imatgetext:"Imagen + Texto", opt_nomesimg:"Solo pictogramas", opt_nomestext:"Solo texto", files_bingo:"Filas", columnes_bingo:"Columnas" },
            en: { mode_fosc:"üåô Dark Mode", idioma_ui:"üåê Application language", clau_api:"ü§ñ Google AI Studio API Key:", desar_clau:"üíæ Save key", aconseguir_clau:"üëâ Get free key", suggerencia:"‚úâÔ∏è Any suggestion?", mida_cartro:"Card size", num_jugadors:"Number of cards", mode_visual:"Display mode", mida_paper_bingo:"Print size", orientacio_paper:"Orientation", paraules_bingo:"Words (comma-separated):", generar_bingo:"üéØ Generate Bingo", mode_ia:"ü§ñ AI Mode", imprimir:"üñ®Ô∏è Print", ia_descripcio:"Enter a theme and AI will generate a word list for the Bingo.", tematica:"Theme:", num_paraules_ia:"Number of words:", generar_ia:"‚ú® Generate words", tancar:"Close", opt_imatgetext:"Image + Text", opt_nomesimg:"Pictograms only", opt_nomestext:"Text only", files_bingo:"Rows", columnes_bingo:"Columns" },
            fr: { mode_fosc:"üåô Mode Sombre", idioma_ui:"üåê Langue de l'application", clau_api:"ü§ñ Cl√© API Google AI Studio :", desar_clau:"üíæ Enregistrer", aconseguir_clau:"üëâ Obtenir une cl√©", suggerencia:"‚úâÔ∏è Une suggestion ?", mida_cartro:"Taille du carton", num_jugadors:"Nombre de cartons", mode_visual:"Mode d'affichage", mida_paper_bingo:"Taille d'impression", orientacio_paper:"Orientation", paraules_bingo:"Mots (s√©par√©s par des virgules) :", generar_bingo:"üéØ G√©n√©rer Bingo", mode_ia:"ü§ñ Mode IA", imprimir:"üñ®Ô∏è Imprimer", ia_descripcio:"Entrez un th√®me et l'IA g√©n√®rera une liste de mots pour le Bingo.", tematica:"Th√®me :", num_paraules_ia:"Nombre de mots :", generar_ia:"‚ú® G√©n√©rer des mots", tancar:"Fermer", opt_imatgetext:"Image + Texte", opt_nomesimg:"Pictogrammes seulement", opt_nomestext:"Texte seulement", files_bingo:"Lignes", columnes_bingo:"Colonnes" },
            ar: { mode_fosc:"üåô ÿßŸÑŸàÿ∂ÿπ ÿßŸÑŸÖÿ∏ŸÑŸÖ", idioma_ui:"üåê ŸÑÿ∫ÿ© ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ", clau_api:"ü§ñ ŸÖŸÅÿ™ÿßÿ≠ API ÿ¨Ÿàÿ¨ŸÑ:", desar_clau:"üíæ ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÅÿ™ÿßÿ≠", aconseguir_clau:"üëâ ÿßÿ≠ÿµŸÑ ÿπŸÑŸâ ŸÖŸÅÿ™ÿßÿ≠ ŸÖÿ¨ÿßŸÜŸä", suggerencia:"‚úâÔ∏è ŸáŸÑ ŸÑÿØŸäŸÉ ÿßŸÇÿ™ÿ±ÿßÿ≠ÿü", mida_cartro:"ÿ≠ÿ¨ŸÖ ÿßŸÑÿ®ÿ∑ÿßŸÇÿ©", num_jugadors:"ÿπÿØÿØ ÿßŸÑÿ®ÿ∑ÿßŸÇÿßÿ™", mode_visual:"Ÿàÿ∂ÿπ ÿßŸÑÿπÿ±ÿ∂", mida_paper_bingo:"ÿ≠ÿ¨ŸÖ ÿßŸÑÿ∑ÿ®ÿßÿπÿ©", orientacio_paper:"ÿßŸÑÿ™Ÿàÿ¨Ÿá", paraules_bingo:"ŸÉŸÑŸÖÿßÿ™ (ŸÖŸÅÿµŸàŸÑÿ© ÿ®ŸÅŸàÿßÿµŸÑ):", generar_bingo:"üéØ ÿ•ŸÜÿ¥ÿßÿ° ÿ®ŸäŸÜÿ∫Ÿà", mode_ia:"ü§ñ Ÿàÿ∂ÿπ AI", imprimir:"üñ®Ô∏è ÿ∑ÿ®ÿßÿπÿ©", ia_descripcio:"ÿßŸÉÿ™ÿ® ŸÖŸàÿ∂ŸàÿπÿßŸã Ÿàÿ≥ÿ™ŸÜÿ¥ÿ¶ ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä ŸÇÿßÿ¶ŸÖÿ© ŸÉŸÑŸÖÿßÿ™ ŸÑŸÑÿ®ŸäŸÜÿ∫Ÿà.", tematica:"ÿßŸÑŸÖŸàÿ∂Ÿàÿπ:", num_paraules_ia:"ÿπÿØÿØ ÿßŸÑŸÉŸÑŸÖÿßÿ™:", generar_ia:"‚ú® ÿ•ŸÜÿ¥ÿßÿ° ŸÉŸÑŸÖÿßÿ™", tancar:"ÿ•ÿ∫ŸÑÿßŸÇ", opt_imatgetext:"ÿµŸàÿ±ÿ© + ŸÜÿµ", opt_nomesimg:"ÿ±ŸÖŸàÿ≤ ŸÅŸÇÿ∑", opt_nomestext:"ŸÜÿµ ŸÅŸÇÿ∑", files_bingo:"ÿµŸÅŸàŸÅ", columnes_bingo:"ÿ£ÿπŸÖÿØÿ©" },
            zh: { mode_fosc:"üåô ÊöóÈªëÊ®°Âºè", idioma_ui:"üåê Â∫îÁî®ËØ≠Ë®Ä", clau_api:"ü§ñ Ë∞∑Ê≠åAI StudioÂØÜÈí•Ôºö", desar_clau:"üíæ ‰øùÂ≠òÂØÜÈí•", aconseguir_clau:"üëâ Ëé∑ÂèñÂÖçË¥πÂØÜÈí•", suggerencia:"‚úâÔ∏è Êúâ‰ªÄ‰πàÂª∫ËÆÆÔºü", mida_cartro:"Âç°ÁâáÂ§ßÂ∞è", num_jugadors:"Âç°ÁâáÊï∞Èáè", mode_visual:"ÊòæÁ§∫Ê®°Âºè", mida_paper_bingo:"ÊâìÂç∞Â§ßÂ∞è", orientacio_paper:"ÊñπÂêë", paraules_bingo:"ËØçËØ≠ÔºàÈÄóÂè∑ÂàÜÈöîÔºâÔºö", generar_bingo:"üéØ ÁîüÊàêÂÆæÊûú", mode_ia:"ü§ñ AIÊ®°Âºè", imprimir:"üñ®Ô∏è ÊâìÂç∞", ia_descripcio:"ËæìÂÖ•‰∏ªÈ¢òÔºåAIÂ∞Ü‰∏∫ÂÆæÊûúÁîüÊàêËØçËØ≠ÂàóË°®„ÄÇ", tematica:"‰∏ªÈ¢òÔºö", num_paraules_ia:"ËØçËØ≠Êï∞ÈáèÔºö", generar_ia:"‚ú® ÁîüÊàêËØçËØ≠", tancar:"ÂÖ≥Èó≠", opt_imatgetext:"ÂõæÁâá+ÊñáÂ≠ó", opt_nomesimg:"‰ªÖÂõæÁ§∫", opt_nomestext:"‰ªÖÊñáÂ≠ó", files_bingo:"Ë°å", columnes_bingo:"Âàó" },
            ur: { mode_fosc:"üåô ⁄àÿßÿ±⁄© ŸÖŸà⁄à", idioma_ui:"üåê ÿß€åŸæ ⁄©€å ÿ≤ÿ®ÿßŸÜ", clau_api:"ü§ñ ⁄ØŸà⁄ØŸÑ AI Studio ⁄©€å ⁄©ŸÑ€åÿØ:", desar_clau:"üíæ ⁄©€å ŸÖÿ≠ŸÅŸàÿ∏ ⁄©ÿ±€å⁄∫", aconseguir_clau:"üëâ ŸÖŸÅÿ™ ⁄©€å ŸÑ€å⁄∫", suggerencia:"‚úâÔ∏è ⁄©Ÿàÿ¶€å ÿ™ÿ¨Ÿà€åÿ≤ÿü", mida_cartro:"⁄©ÿßÿ±⁄à ⁄©ÿß ÿ≥ÿßÿ¶ÿ≤", num_jugadors:"⁄©ÿßÿ±⁄àÿ≤ ⁄©€å ÿ™ÿπÿØÿßÿØ", mode_visual:"⁄àÿ≥ŸæŸÑ€í ŸÖŸà⁄à", mida_paper_bingo:"Ÿæÿ±ŸÜŸπ ÿ≥ÿßÿ¶ÿ≤", orientacio_paper:"ÿ≥ŸÖÿ™", paraules_bingo:"ÿßŸÑŸÅÿßÿ∏ (⁄©ÿßŸÖÿß ÿ≥€í ÿßŸÑ⁄Ø):", generar_bingo:"üéØ ÿ®ŸÜ⁄ØŸà ÿ®ŸÜÿßÿ¶€å⁄∫", mode_ia:"ü§ñ AI ŸÖŸà⁄à", imprimir:"üñ®Ô∏è Ÿæÿ±ŸÜŸπ", ia_descripcio:"ÿß€å⁄© ŸÖŸàÿ∂Ÿàÿπ ŸÑ⁄©⁄æ€å⁄∫ ÿßŸàÿ± AI ÿ®ŸÜ⁄ØŸà ⁄©€í ŸÑ€å€í ÿßŸÑŸÅÿßÿ∏ ⁄©€å ŸÅ€Åÿ±ÿ≥ÿ™ ÿ®ŸÜÿßÿ¶€í ⁄Øÿß€î", tematica:"ŸÖŸàÿ∂Ÿàÿπ:", num_paraules_ia:"ÿßŸÑŸÅÿßÿ∏ ⁄©€å ÿ™ÿπÿØÿßÿØ:", generar_ia:"‚ú® ÿßŸÑŸÅÿßÿ∏ ÿ®ŸÜÿßÿ¶€å⁄∫", tancar:"ÿ®ŸÜÿØ ⁄©ÿ±€å⁄∫", opt_imatgetext:"ÿ™ÿµŸà€åÿ± + ŸÖÿ™ŸÜ", opt_nomesimg:"ÿµÿ±ŸÅ ÿ™ÿµŸà€åÿ±€å⁄∫", opt_nomestext:"ÿµÿ±ŸÅ ŸÖÿ™ŸÜ", files_bingo:"ÿµŸÅ€å⁄∫", columnes_bingo:"⁄©ÿßŸÑŸÖ" }
        };

        function canviarIdiomaInterficie(lang) {
            localStorage.setItem('ui_lang', lang);
            const t = i18nUI[lang] || i18nUI['ca'];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.dataset.i18n;
                if (t[key] !== undefined) el.textContent = t[key];
            });
            document.querySelectorAll('[data-i18n-opt]').forEach(el => {
                const key = el.dataset.i18nOpt;
                if (t[key] !== undefined) el.textContent = t[key];
            });
            const sel = document.getElementById('ui-lang-select');
            if (sel && sel.value !== lang) sel.value = lang;
        }

        // Fisher-Yates shuffle
        function barrejar(arr) {
            const a = [...arr];
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }

        function generarBingo() {
            const files = parseInt(document.getElementById('bingo-files').value) || 5;
            const columnes = parseInt(document.getElementById('bingo-columnes').value) || 5;
            const numJugadors = parseInt(document.getElementById('num-jugadors').value);
            const modeVisual = document.getElementById('mode-visual').value;
            const textParaules = document.getElementById('llista-paraules').value;
            const avis = document.getElementById('avis-paraules');

            const llista = textParaules.split(',').map(p => p.trim()).filter(p => p !== '');
            const cellsPerCard = files * columnes;

            // Math: minimum words needed = cells_per_card + num_players (so each card can be different)
            const minParaules = cellsPerCard + numJugadors;

            avis.style.display = 'none';
            avis.className = 'avis';

            if (llista.length === 0) {
                avis.textContent = '‚ö†Ô∏è Afegeix paraules a la llista per generar els cartrons.';
                avis.className = 'avis error';
                avis.style.display = 'block';
                return;
            }

            if (llista.length < cellsPerCard) {
                avis.textContent = `‚ö†Ô∏è Necessites almenys ${cellsPerCard} paraules per omplir un cartr√≥ de ${files}√ó${columnes}. Tens ${llista.length} paraules.`;
                avis.className = 'avis error';
                avis.style.display = 'block';
                return;
            }

            if (llista.length < minParaules) {
                avis.textContent = `‚ö†Ô∏è Amb ${numJugadors} cartrons de ${files}√ó${columnes}, es recomanen almenys ${minParaules} paraules per evitar cartrons id√®ntics. Tens ${llista.length}. Es generaran igualment per√≤ alguns cartrons podrien ser similars.`;
                avis.className = 'avis';
                avis.style.display = 'block';
            }

            const zona = document.getElementById('zona-sortida');
            zona.innerHTML = '';
            const container = document.createElement('div');
            container.className = 'cards-container';

            // Generate cards
            const cardsGenerated = [];
            for (let c = 0; c < numJugadors; c++) {
                const shuffled = barrejar(llista);
                const selected = shuffled.slice(0, cellsPerCard);
                cardsGenerated.push(selected);
            }

            cardsGenerated.forEach((words, idx) => {
                const card = document.createElement('div');
                card.className = 'bingo-card';

                const title = document.createElement('div');
                title.className = 'bingo-card-title';
                title.textContent = `üéØ Cartr√≥ ${idx + 1}`;
                card.appendChild(title);

                const grid = document.createElement('div');
                grid.className = 'bingo-grid';
                grid.style.gridTemplateColumns = `repeat(${columnes}, 1fr)`;

                words.forEach(word => {
                    const cell = document.createElement('div');
                    cell.className = 'bingo-cell';
                    cell.style.cursor = 'pointer';
                    cell.addEventListener('click', () => obrirModal(cell));
                    if (modeVisual === 'nomes-text') cell.classList.add('nomes-text');
                    if (modeVisual === 'nomes-img') cell.classList.add('nomes-img');

                    const img = document.createElement('img');
                    img.alt = word;
                    img.src = 'https://upload.wikimedia.org/wikipedia/commons/c/ca/1x1.png';
                    img.style.opacity = '0.1';
                    // Load pictogram from ARASAAC
                    const encodedWord = encodeURIComponent(word);
                    const arasaacLang = localStorage.getItem('ui_lang') || 'ca';
                    fetch(`https://api.arasaac.org/v1/pictograms/${arasaacLang}/search/${encodedWord}`)
                        .then(r => r.json())
                        .then(data => {
                            if (data && data.length > 0) {
                                img.src = `https://static.arasaac.org/pictograms/${data[0]._id}/${data[0]._id}_300.png`;
                                img.style.opacity = '1';
                            }
                        })
                        .catch(() => {});

                    const text = document.createElement('span');
                    text.className = 'cell-text';
                    text.textContent = word;

                    cell.appendChild(img);
                    cell.appendChild(text);
                    grid.appendChild(cell);
                });

                card.appendChild(grid);
                container.appendChild(card);
            });

            zona.appendChild(container);

            if (llista.length >= cellsPerCard && llista.length >= minParaules) {
                avis.textContent = `‚úÖ ${numJugadors} cartrons de ${files}√ó${columnes} generats correctament amb ${llista.length} paraules.`;
                avis.className = 'avis ok';
                avis.style.display = 'block';
            }
        }

        function imprimirBingo() {
            const mida = document.getElementById('mida-paper').value.toUpperCase();
            const orientacio = document.getElementById('orientacio-paper').value;
            let styleEl = document.getElementById('print-page-style');
            if (!styleEl) {
                styleEl = document.createElement('style');
                styleEl.id = 'print-page-style';
                document.head.appendChild(styleEl);
            }
            styleEl.textContent = `@media print { @page { size: ${mida} ${orientacio}; margin: 10mm; } }`;
            window.print();
        }

        function obrirModalIA() {
            const geminiKey = (localStorage.getItem('gemini_api_key') || '').trim();
            const orKey = (localStorage.getItem('openrouter_api_key') || '').trim();
            if (!geminiKey && !orKey) {
                alert('‚ö†Ô∏è Necessites una clau API per usar el Mode IA. Afegeix-la al men√∫ lateral (bot√≥ "Activa la IA!").');
                return;
            }
            document.getElementById('modal-ia').style.display = 'flex';
        }

        async function generarParaulesIA() {
            const tematica = document.getElementById('ia-tematica').value.trim();
            const numParaules = parseInt(document.getElementById('ia-num-paraules').value) || 30;
            const estat = document.getElementById('ia-estat');

            if (!tematica) { estat.textContent = '‚ö†Ô∏è Escriu una tem√†tica.'; return; }

            estat.innerHTML = '<span style="display:inline-block;width:18px;height:18px;border:3px solid #f3f3f3;border-top:3px solid #8e44ad;border-radius:50%;animation:spin 1s linear infinite;vertical-align:middle;margin-right:6px;"></span> Generant paraules...';

            const prompt = `Generate a list of exactly ${numParaules} words or short expressions (maximum 3 words each) about the theme: "${tematica}". The words must be suitable for primary school or special education students. Respond ONLY with the words separated by commas, in the same language as the theme provided, without numbering or any additional explanation.`;

            try {
                const text = await apiCallWithFallback(prompt, { temperature: 0.7, maxOutputTokens: 500 });
                const paraules = text.split(',').map(p => p.trim().replace(/\n/g, ' ')).filter(p => p.length > 0);
                document.getElementById('llista-paraules').value = paraules.join(', ');
                estat.textContent = `‚úÖ ${paraules.length} paraules generades!`;
                setTimeout(() => {
                    document.getElementById('modal-ia').style.display = 'none';
                    estat.textContent = '';
                }, 1500);
            } catch (e) {
                if (e.message === 'no_key') {
                    estat.textContent = '‚ùå Afegeix una clau API al men√∫ lateral.';
                } else {
                    estat.textContent = `‚ùå Error: ${e.message}`;
                }
            }
        }

        // ‚îÄ‚îÄ Editor modal de casella (igual que Targetes) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        let elementEditant = null;
        let imgOriginalSrcOnOpen = '';
        let currentColorSelected = '#ffffff';
        let editorCanvas, editorCtx;
        let editorImgObj = new Image();
        editorImgObj.crossOrigin = "Anonymous";
        let currentDrawings = [];
        let isDrawing = false;
        let drawColor = '#e74c3c';
        let currentTool = 'freehand';
        let startX, startY, currentX, currentY;
        let isDraggingShape = false;
        let draggedShapeIndex = -1;
        let selectedShapeIndex = -1;
        let lastMouseX = 0, lastMouseY = 0;

        function obrirModal(cell) {
            elementEditant = cell;
            imgOriginalSrcOnOpen = cell.querySelector('img') ? cell.querySelector('img').src : '';
            currentDrawings = [];
            const textEl = cell.querySelector('.cell-text');
            const word = textEl ? textEl.textContent.trim() : '';
            const containerInputs = document.getElementById('camps-text');
            containerInputs.innerHTML = '';
            containerInputs.className = 'inputs-container-modal dues-paraules';
            containerInputs.innerHTML = `<input type="text" class="input-text-modal" id="input-modal-0" value="${word.replace(/"/g,'&quot;')}" placeholder="Text de la casella">`;
            document.getElementById('input-arasaac').value = word;
            document.getElementById('resultats-traductor').innerHTML = '';
            document.getElementById('modal-edicio').style.display = 'flex';
            canviarPestanya('tab-arasaac');
            if (word) buscarArasaacModal();
        }

        function guardarTancar() {
            if (elementEditant) {
                if (document.getElementById('tab-dibuix').style.display === 'block') {
                    aplicarEdicioImatge(false);
                }
                const inp = document.getElementById('input-modal-0');
                const trimmed = inp ? inp.value.trim() : '';
                const words = trimmed.split(/\s+/).filter(w => w.length > 0);
                const finalText = words.slice(0, 2).join(' ');
                const textEl = elementEditant.querySelector('.cell-text');
                if (textEl) textEl.textContent = finalText;
                if (currentColorSelected !== '#ffffff') {
                    elementEditant.style.backgroundColor = currentColorSelected;
                }
            }
            tancarModal();
        }

        function tancarModalSenseGuardar() {
            if (elementEditant && imgOriginalSrcOnOpen) {
                const img = elementEditant.querySelector('img');
                if (img) img.src = imgOriginalSrcOnOpen;
            }
            tancarModal();
        }

        function tancarModal() {
            document.getElementById('modal-edicio').style.display = 'none';
            elementEditant = null;
            currentColorSelected = '#ffffff';
            document.querySelectorAll('.color-btn').forEach(b => b.style.borderColor = '#ccc');
        }

        function eliminarTargeta() {
            if (!elementEditant) return;
            if (confirm('Segur que vols buidar aquesta casella?')) {
                const img = elementEditant.querySelector('img');
                if (img) {
                    img.src = 'https://upload.wikimedia.org/wikipedia/commons/c/ca/1x1.png';
                    img.style.opacity = '0.1';
                }
                const textEl = elementEditant.querySelector('.cell-text');
                if (textEl) textEl.textContent = '';
                tancarModal();
            }
        }

        function aplicarImatge(src) {
            if (elementEditant) {
                const img = elementEditant.querySelector('img');
                if (img) { img.src = src; img.style.opacity = '1'; }
            }
        }

        function canviarPestanya(id) {
            document.querySelectorAll('.contingut-tab').forEach(e => e.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('actiu'));
            const tab = document.getElementById(id);
            if (tab) tab.style.display = 'block';
            document.querySelectorAll(`.tab-btn[onclick*="${id}"]`).forEach(b => b.classList.add('actiu'));
        }

        async function buscarArasaacModal() {
            const q = document.getElementById('input-arasaac').value;
            const div = document.getElementById('resultats-arasaac');
            div.innerHTML = '';
            const lang = localStorage.getItem('ui_lang') || 'ca';
            try {
                const r = await fetch(`https://api.arasaac.org/api/pictograms/${lang}/search/${encodeURIComponent(q)}`);
                const d = await r.json();
                const urls = d.map(x => `https://static.arasaac.org/pictograms/${x._id}/${x._id}_300.png`);
                urls.forEach(url => { const i = document.createElement('img'); i.src = url; i.onclick = () => aplicarImatge(url); div.appendChild(i); });
                if (d.length === 0) {
                    try {
                        const gsR = await fetch(`https://www.globalsymbols.com/api/v1/labels/search/?query=${encodeURIComponent(q)}&language=${lang}&limit=20`);
                        const gsD = await gsR.json();
                        (gsD.results || gsD || []).forEach(item => { const url = item.picto?.image_url || item.image_url; if (url) { const i = document.createElement('img'); i.src = url; i.onclick = () => aplicarImatge(url); div.appendChild(i); } });
                    } catch(e2) {}
                }
            } catch(e) {}
        }

        function pujarImatge(i) {
            const r = new FileReader();
            r.onload = e => aplicarImatge(e.target.result);
            if (i.files[0]) r.readAsDataURL(i.files[0]);
        }

        async function traduirParaula() {
            const word = (document.getElementById('input-modal-0') || {}).value || '';
            const divRes = document.getElementById('resultats-traductor');
            divRes.innerHTML = "<p style='text-align:center'>‚è≥ Traduint...</p>";
            let html = '';
            const checkboxes = document.querySelectorAll('.check-trad:checked');
            if (checkboxes.length === 0) { divRes.innerHTML = "<p style='text-align:center'>‚ö†Ô∏è Selecciona com a m√≠nim un idioma.</p>"; return; }
            for (const cb of checkboxes) {
                const langCode = cb.value;
                const langNom = cb.parentNode.innerText.trim();
                try {
                    const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(word)}&langpair=ca|${langCode}`);
                    const data = await res.json();
                    if (data.responseData && data.responseData.translatedText) {
                        if (data.responseData.translatedText.includes('MYMEMORY WARNING')) { html += `<p style='text-align:center;color:#e74c3c;grid-column:1/-1;'>‚ö†Ô∏è L√≠mit diari esgotat.</p>`; break; }
                        html += `<div class="item-traduccio" onclick="copiarText('${data.responseData.translatedText.replace(/'/g,"\\'").replace(/"/g,'&quot;')}')"><div><span class="lang-code">${langNom}</span><span class="trad-text">${data.responseData.translatedText}</span></div><span class="copy-hint">üìã</span></div>`;
                    }
                } catch(e) {}
            }
            divRes.innerHTML = html || "Error de connexi√≥";
        }

        function copiarText(t) {
            navigator.clipboard.writeText(t);
            const o = document.getElementById('toast');
            o.style.display = 'block';
            setTimeout(() => o.style.display = 'none', 2000);
        }

        function setTargetColor(color, btnElem) {
            currentColorSelected = color;
            document.querySelectorAll('.color-btn').forEach(b => b.style.borderColor = '#ccc');
            if (btnElem) btnElem.style.borderColor = '#333';
        }

        function setTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.btn-tool').forEach(btn => btn.classList.remove('actiu'));
            const el = document.getElementById('tool-' + tool);
            if (el) el.classList.add('actiu');
        }

        function setDrawColor(c) { drawColor = c; }
        function undoLastDrawing() { if (currentDrawings.length > 0) { currentDrawings.pop(); selectedShapeIndex = -1; drawEditorCanvas(); } }
        function eliminarElementSeleccionat() { if (selectedShapeIndex >= 0 && selectedShapeIndex < currentDrawings.length) { currentDrawings.splice(selectedShapeIndex, 1); selectedShapeIndex = -1; drawEditorCanvas(); } }

        function getMousePos(e) {
            const rect = editorCanvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: clientX - rect.left, y: clientY - rect.top };
        }

        function buildPath(ctx, shape) {
            ctx.beginPath();
            if (shape.type === 'freehand') { shape.points.forEach((p, i) => { if(i===0) ctx.moveTo(p.x,p.y); else ctx.lineTo(p.x,p.y); }); }
            else if (shape.type === 'rect') { ctx.rect(shape.start.x, shape.start.y, shape.end.x - shape.start.x, shape.end.y - shape.start.y); }
            else if (shape.type === 'circle') { let r = Math.sqrt(Math.pow(shape.end.x-shape.start.x,2)+Math.pow(shape.end.y-shape.start.y,2)); ctx.arc(shape.start.x,shape.start.y,r,0,2*Math.PI); }
            else if (shape.type === 'arrow') { let hl=15,dx=shape.end.x-shape.start.x,dy=shape.end.y-shape.start.y,ang=Math.atan2(dy,dx); ctx.moveTo(shape.start.x,shape.start.y); ctx.lineTo(shape.end.x,shape.end.y); ctx.lineTo(shape.end.x-hl*Math.cos(ang-Math.PI/6),shape.end.y-hl*Math.sin(ang-Math.PI/6)); ctx.moveTo(shape.end.x,shape.end.y); ctx.lineTo(shape.end.x-hl*Math.cos(ang+Math.PI/6),shape.end.y-hl*Math.sin(ang+Math.PI/6)); }
            else if (shape.type === 'cross') { ctx.moveTo(shape.start.x,shape.start.y); ctx.lineTo(shape.end.x,shape.end.y); ctx.moveTo(shape.end.x,shape.start.y); ctx.lineTo(shape.start.x,shape.end.y); }
            else if (shape.type === 'text') { ctx.rect(shape.start.x-5,shape.start.y-14,(shape.text||'').length*8+10,20); }
        }

        function getHitShapeIndex(x, y) {
            editorCtx.lineWidth = 15;
            for (let i = currentDrawings.length-1; i >= 0; i--) { buildPath(editorCtx, currentDrawings[i]); if (editorCtx.isPointInStroke(x,y)) return i; }
            return -1;
        }

        function startDrawingCanvas(e) {
            const pos = getMousePos(e);
            let hitIdx = getHitShapeIndex(pos.x, pos.y);
            if (hitIdx !== -1) { isDraggingShape = true; draggedShapeIndex = hitIdx; selectedShapeIndex = hitIdx; lastMouseX = pos.x; lastMouseY = pos.y; drawEditorCanvas(); }
            else if (currentTool === 'text') {
                const inlineInput = document.getElementById('canvas-inline-text');
                if (inlineInput) {
                    inlineInput.style.left = pos.x + 'px'; inlineInput.style.top = (pos.y-18) + 'px';
                    inlineInput.style.display = 'block'; inlineInput.value = ''; inlineInput.focus();
                    inlineInput._pendingPos = {x: pos.x, y: pos.y};
                    inlineInput.onkeydown = function(ev) { if (ev.key==='Enter'){ev.preventDefault();inlineInput.blur();} if(ev.key==='Escape'){inlineInput.style.display='none';inlineInput.onblur=null;} };
                    inlineInput.onblur = function() {
                        const txt = inlineInput.value.trim(); inlineInput.style.display = 'none';
                        if (txt && inlineInput._pendingPos) { currentDrawings.push({type:'text',color:drawColor,start:{x:inlineInput._pendingPos.x,y:inlineInput._pendingPos.y},text:txt}); selectedShapeIndex=currentDrawings.length-1; drawEditorCanvas(); }
                    };
                }
            } else {
                selectedShapeIndex = -1; isDrawing = true; startX = pos.x; startY = pos.y; currentX = pos.x; currentY = pos.y;
                if (currentTool === 'freehand') currentDrawings.push({type:'freehand',color:drawColor,points:[{x:startX,y:startY}]});
                drawEditorCanvas();
            }
        }

        function drawCanvas(e) {
            const pos = getMousePos(e);
            if (isDraggingShape) { let dx=pos.x-lastMouseX,dy=pos.y-lastMouseY,shape=currentDrawings[draggedShapeIndex]; if(shape.type==='freehand') shape.points.forEach(pt=>{pt.x+=dx;pt.y+=dy;}); else{shape.start.x+=dx;shape.start.y+=dy;if(shape.end){shape.end.x+=dx;shape.end.y+=dy;}} lastMouseX=pos.x;lastMouseY=pos.y;drawEditorCanvas(); }
            else if (isDrawing) { currentX=pos.x;currentY=pos.y;if(currentTool==='freehand')currentDrawings[currentDrawings.length-1].points.push({x:currentX,y:currentY});drawEditorCanvas(); }
            else { let hitIdx=getHitShapeIndex(pos.x,pos.y);editorCanvas.style.cursor=hitIdx!==-1?'pointer':'crosshair'; }
        }

        function stopDrawingCanvas() {
            if (isDraggingShape){isDraggingShape=false;draggedShapeIndex=-1;}
            if (isDrawing){isDrawing=false;if(currentTool!=='freehand'&&(startX!==currentX||startY!==currentY)){currentDrawings.push({type:currentTool,color:drawColor,start:{x:startX,y:startY},end:{x:currentX,y:currentY}});}drawEditorCanvas();}
        }

        function obrirTabEdicio() {
            canviarPestanya('tab-dibuix');
            document.getElementById('ed-scale').value = 1;
            document.getElementById('ed-x').value = 0;
            document.getElementById('ed-y').value = 0;
            setTool('freehand');
            const img = elementEditant ? elementEditant.querySelector('img') : null;
            let currentSrc = img ? img.src : '';
            if (currentSrc) {
                if (currentSrc.indexOf('static.arasaac.org') !== -1 && currentSrc.indexOf('?') === -1 && !currentSrc.endsWith('.mp4')) { currentSrc += '?c=' + new Date().getTime(); }
                editorImgObj.onload = () => { currentDrawings = []; drawEditorCanvas(); editorImgObj.onload = null; };
                editorImgObj.src = currentSrc;
                if (editorImgObj.complete) editorImgObj.onload();
            }
        }

        function drawEditorCanvas() {
            editorCtx.clearRect(0,0,300,300);
            const scale=parseFloat(document.getElementById('ed-scale').value);
            const dx=parseFloat(document.getElementById('ed-x').value);
            const dy=parseFloat(document.getElementById('ed-y').value);
            editorCtx.save(); editorCtx.translate(150+dx,150+dy); editorCtx.scale(scale,scale);
            if(editorImgObj.src&&!editorImgObj.src.endsWith('.mp4')){const asp=editorImgObj.width/editorImgObj.height;let w=280,h=280;if(asp>1)h=w/asp;else w=h*asp;editorCtx.drawImage(editorImgObj,-w/2,-h/2,w,h);}
            editorCtx.restore(); editorCtx.lineCap='round'; editorCtx.lineJoin='round';
            currentDrawings.forEach((shape,idx)=>{
                if(shape.type==='text'){editorCtx.fillStyle=shape.color;editorCtx.font='bold 16px Arial';editorCtx.fillText(shape.text||'',shape.start.x,shape.start.y);if(idx===selectedShapeIndex){editorCtx.strokeStyle='#4a90e2';editorCtx.lineWidth=1;editorCtx.setLineDash([3,3]);buildPath(editorCtx,shape);editorCtx.stroke();editorCtx.setLineDash([]);}}
                else{if(idx===selectedShapeIndex){editorCtx.strokeStyle='rgba(74,144,226,0.55)';editorCtx.lineWidth=10;editorCtx.setLineDash([]);buildPath(editorCtx,shape);editorCtx.stroke();}editorCtx.strokeStyle=shape.color;editorCtx.lineWidth=4;buildPath(editorCtx,shape);editorCtx.stroke();}
            });
            if(isDrawing&&currentTool!=='freehand'){editorCtx.strokeStyle=drawColor;editorCtx.lineWidth=4;buildPath(editorCtx,{type:currentTool,start:{x:startX,y:startY},end:{x:currentX,y:currentY}});editorCtx.stroke();}
        }

        function aplicarEdicioImatge(canviarTab=true){const dataUrl=editorCanvas.toDataURL('image/png');aplicarImatge(dataUrl);if(canviarTab)canviarPestanya('tab-arasaac');}

        window.addEventListener('load', function() {
            editorCanvas = document.getElementById('canvasEditor');
            if (editorCanvas) {
                editorCtx = editorCanvas.getContext('2d');
                editorCanvas.addEventListener('mousedown', startDrawingCanvas);
                editorCanvas.addEventListener('mousemove', drawCanvas);
                window.addEventListener('mouseup', stopDrawingCanvas);
                editorCanvas.addEventListener('touchstart', e => { e.preventDefault(); startDrawingCanvas(e); }, {passive: false});
                editorCanvas.addEventListener('touchmove', e => { e.preventDefault(); drawCanvas(e); }, {passive: false});
                window.addEventListener('touchend', stopDrawingCanvas);
            }
            const lang = localStorage.getItem('ui_lang') || 'ca';
            canviarIdiomaInterficie(lang);
        });
    </script>
</body>
</html>
